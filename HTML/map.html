<div  ng-if="!loadComplete" layout="column" layout-align="center center" layout-fill>
    <div ng-if="!errorContext" layout="column" layout-align="center center">
        <md-progress-circular md-mode="indeterminate"></md-progress-circular>
        <span style="margin-top: 15px;">Fetching map data...</span>
    </div>
    <div ng-if="errorContext" layout="row" layout-align="center" style="width: 75%;">
        <div layout="column">
            <div layout="row" class="rem2_25Text">
                <i ng-if="errorContext.status != 403" class="fa fa-exclamation-circle fa-fw errorMessageColor" aria-hidden="true"></i>
                <i ng-if="errorContext.status == 403" class="fa fa-exclamation-triangle fa-fw warningMessageColor" aria-hidden="true"></i>
            </div>
        </div>
        <div layout="column">
            <div layout="row" class="rem2_25Text">
                <span ng-if="errorContext.status != 403" class="errorMessageColor">A fatal error has occurred.</span>
                <span ng-if="errorContext.status == 403" class="warningMessageColor">Access is blocked.</span>
            </div>
            <div layout="column">
                {{errorContext.message}}
                <span ng-if="!errorContext.innerException && errorContext.stackTrace && errorContext.status != 403" style="white-space: pre-wrap; color: gray;">{{formatStackTrace(errorContext.stackTrace)}}</span>
            </div>
            <div ng-if="errorContext.innerException" layout="column">
                <span>{{errorContext.innerException.message}}</span>
                <span style="white-space: pre-wrap; color: gray;">{{formatStackTrace(errorContext.innerException.stackTrace)}}</span>
            </div>
        </div>
    </div>
</div>
<div ng-if="loadComplete" layout="row" layout-fill>
    <!--Button toolbar-->
    <div id="divToolbar" layout="column" layout-align="space-between center" class="verticalPadding toolbarColor" style="width: 55px; height: 100%;">
        <div>
            <md-button id="btnShowSideNav" class="md-icon-button" ng-class="{'toolbarButtonColor': displayUnits}" ng-click="displayUnits = !displayUnits; displayTile = false;">
                <i class="fa fa-bars fa-lg" aria-hidden="true"></i>
            </md-button>
            <md-button id="btnShowTileInfo" class="md-icon-button" ng-class="{'toolbarButtonColor': displayTile}" ng-click="displayTile = !displayTile; displayUnits = false;">
                <i class="fa fa-square-o fa-lg" aria-hidden="true"></i>
            </md-button>
        </div>
        <div>
            <md-button id="btnLaunchConvoy" class="md-icon-button" ng-if="data.showConvoyLink" ng-click="navigateConvoy()">
                <i class="fa fa-archive fa-lg" aria-hidden="true"></i>
            </md-button>
            <md-button id="btnLaunchShop" class="md-icon-button" ng-if="data.showShopLink" ng-click="navigateShop()">
                <i class="fa fa-shopping-basket fa-lg" aria-hidden="true"></i>
            </md-button>
            <md-button id="btnLaunchChapterPost" class="md-icon-button" ng-if="data.chapterPostURL.length > 0" ng-click="launchChapterPostTab()">
                <i class="fa fa-reddit fa-lg" aria-hidden="true"></i>
            </md-button>
            <md-button id="btnBack" class="md-icon-button" ng-click="navigateHome()">
                <i class="fa fa-arrow-left fa-lg" aria-hidden="true"></i>
            </md-button>
        </div>
    </div>
    <!-- Search and unit display -->
    <div id="divUnitDisplay" ng-show="displayUnits" layout="column" class="verticalPadding horizontalPadding slide" style="width: 375px; height: 100%;">
        <!-- Search field -->
        <md-autocomplete
                id="mdAutoComplete"
                md-selected-item="selectedUnit"
                md-search-text="searchQuery"
                md-items="unit in data.units | orderBy: [unitSort, 'name'] | filter: searchQuery"
                md-item-text="unit.name"
                md-dropdown-items="5"
                md-min-length="0"
                md-escape-options="clear"
                md-no-cache="true"
                placeholder="Unit Name">
            <md-item-template>
                <div layout="row" layout-align="space-between center">
                    <span md-highlight-text="searchQuery" md-highlight-flags="^i">{{unit.name}}</span>
                    <div layout="row">
                        <i ng-if="unit.coordinates.x < 1 || unit.coordinates.y < 1" class="fa fa-eye-slash fa-lg fa-fw" aria-hidden="true"><md-tooltip md-direction="top">Hidden</md-tooltip></i>
                        <i ng-if="unit.pinned" class="fa fa-thumb-tack fa-lg fa-fw fa-rotate-45" aria-hidden="true"><md-tooltip md-direction="top">Pinned</md-tooltip></i>
                    </div>
                </div>
            </md-item-template>
        </md-autocomplete>
        <!--Unit display-->
        <md-content ng-if="selectedUnit" layout-padding>
            <!-- Sprite, name, & pin icon -->
            <div layout="row" layout-align="space-between">
                <div layout="column">
                    <div layout="row">
                        <img ng-src="{{selectedUnit.spriteURL}}" style="max-width: 100px; max-height: 100px;"/>
                    </div>
                    <div layout="row">
                        <div layout="column" class="rem1_4Text boldText">
                            <i class="fa fa-angle-down fa-fw clickable" ng-class="{'fa-rotate-270': !unitInfoExpanded}" ng-click="unitInfoExpanded = !unitInfoExpanded" aria-hidden="true"></i>
                        </div>
                        <div layout="column">
                            <span class="rem1_4Text boldText">{{selectedUnit.name}}</span>
                            <span class="rem0_9Text leftPadding">Lvl. {{selectedUnit.level}} {{selectedUnit.classes[0]}}</span>
                        </div>
                    </div>
                </div>
                <div layout="column">
                    <i ng-click="toggleUnitPinnedStatus(selectedUnit)" ng-class="{'opacity50': !selectedUnit.pinned}" class="fa fa-thumb-tack fa-lg fa-rotate-45 clickable" aria-hidden="true">
                        <md-tooltip md-direction="left">{{selectedUnit.pinned ? 'Unpin' : 'Pin'}} unit</md-tooltip>
                    </i>
                </div>
            </div>
            <!--Expanded unit info-->
            <div layout="column" ng-if="unitInfoExpanded">
                <div layout="row" ng-repeat="text in selectedUnit.textFields" class="rem0_9Text bottomMargin">
                    {{text}}
                </div>
                <div ng-if="selectedUnit.player.length > 0" layout="row" class="rem0_9Text bottomMargin">
                    <b>Player</b>: {{selectedUnit.player}}
                </div>
                <div ng-repeat="class in selectedUnit.classes" layout="column" class="bottomMargin">
                    <div layout="row" class="rem0_9Text">
                        <b>Class</b>: {{class}}
                    </div>
                    <div layout="row" ng-repeat="text in data.system.classes[class].textFields" class="rem0_8Text leftPadding" ng-class="{'bottomMargin': !$last}">
                        {{text}}
                    </div>
                </div>
                <div layout="column">
                    <div layout="row" class="rem0_9Text">
                        <b>Affiliation</b>: {{selectedUnit.affiliation}}
                    </div>
                    <div layout="row" ng-repeat="text in data.system.affiliations[selectedUnit.affiliation].textFields" class="rem0_8Text leftPadding">
                        {{text}}
                    </div>
                </div>      
            </div>
            <md-divider ng-if="unitInfoExpanded"></md-divider>
            <div layout="row" layout-wrap>
                <!--HP-->
                <div layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                    <span>HP</span>
                    <span>{{selectedUnit.hp.current}} / {{selectedUnit.hp.maximum}}</span>
                </div>
                <!--Exp-->
                <div layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                    <span>Exp</span>
                    <span>{{selectedUnit.experience}}</span>
                </div>
                <!--Currency-->
                <div ng-if="selectedUnit.heldCurrency > 0" layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                    <span>Money</span>
                    <span>
                        <span ng-if="data.system.currency.isSymbolLeftAligned"><span ng-if="data.currency.includeSpace">&nbsp;</span>{{data.system.currency.currencySymbol}}</span>{{selectedUnit.heldCurrency}}<span ng-if="!data.system.currency.isSymbolLeftAligned"><span ng-if="data.currency.includeSpace">&nbsp;</span>{{data.system.currency.currencySymbol}}</span>
                    </span>
                </div>
            </div>
            <!--Tags-->
            <div layout="row" ng-if="selectedUnit.tags.length > 0">
                <div layout="column" style="margin-right: 8px; padding-top: 5px;">
                    <i class="fa fa-tags" aria-hidden="true">
                        <md-tooltip md-direction="top">Tags</md-tooltip>
                    </i>
                </div>
                <div layout="row" layout-wrap>
                    <div ng-repeat="tag in selectedUnit.tags" class="md-chip-custom">{{tag}}</div>
                </div>
            </div>
            <!-- Stats -->
            <div class="rem1_2Text boldText" layout="row">
                <i class="fa fa-angle-down fa-fw clickable" ng-class="{'fa-rotate-270': !statsExpanded}" ng-click="toggleStatsExpanded()" aria-hidden="true"></i>
                Stats
            </div>
            <!-- Calculated stats -->
            <div layout="row" layout-wrap>
                <div ng-repeat="(stat, val) in selectedUnit.calculatedStats" layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                    <span>{{stat}}</span>
                    <span>{{val}}</span>
                </div>
            </div>
            <!-- Regular stats -->
            <div layout="row" layout-wrap>
                <div ng-repeat="(stat, statObj) in selectedUnit.stats" layout="column" flex="50" class="horizontalPadding">
                    <div layout="row" layout-align="space-between">
                        <span>{{stat}}</span>
                        <span ng-class="{'buffedStatColor': statObj.finalValue > statObj.baseValue, 'debuffedStatColor': statObj.finalValue < statObj.baseValue}">
                            <i class="fa fa-long-arrow-up" ng-if="statObj.finalValue > statObj.baseValue" aria-hidden="true"></i><i class="fa fa-long-arrow-down" ng-if="statObj.finalValue < statObj.baseValue" aria-hidden="true"></i> {{statObj.finalValue}}
                        </span>
                    </div>
                    <div layout="column" ng-if="statsExpanded" class="rem0_8Text leftPadding halfBottomMargin">
                        <div layout="row" layout-align="space-between">
                            <span>Base</span><span>{{statObj.baseValue}}</span>
                        </div>
                        <div ng-repeat="(mod, modVal) in statObj.modifiers" layout="row" layout-align="space-between">
                            <span>{{mod}}</span><span>{{modVal}}</span>
                        </div>
                    </div>
                </div>
            </div>
            <!--Weapon ranks-->
            <div layout="row">
                <div layout="row" style="margin-right: 8px; padding-top: 5px;">
                    <i class="fa fa-tasks" aria-hidden="true">
                        <md-tooltip md-direction="top">Weapon Ranks</md-tooltip>
                    </i>
                </div>
                <div layout="row" layout-wrap>
                    <div ng-repeat="(tag, rank) in selectedUnit.weaponRanks" class="md-chip-custom">{{tag}}<span ng-if="rank.length > 0"> - {{rank}}</span></div>
                </div>
            </div>
            <!-- Statuses -->
            <div ng-if="selectedUnit.statuses.length > 0" layout="row">
                <div layout="row" style="margin-right: 8px; padding-top: 5px;">
                    <i class="fa fa-medkit" aria-hidden="true">
                        <md-tooltip md-direction="top">Status Conditions</md-tooltip>
                    </i>
                </div>
                <div ng-if="true" layout="column" flex="100" style="padding-right: 8px;">
                    <div ng-repeat="status in selectedUnit.statuses"
                         ng-init="statusData = data.system.statuses[status.name]" 
                         class="md-chip-custom"
                         style="width: 100%;">
                         <div layout="row" layout-align="space-between center" class="boldText">
                            <span>
                                {{status.name}}
                                <span ng-if="status.remainingTurns > 0">
                                    ({{status.remainingTurns}}<span ng-if="statusData.turns > 0">/{{statusData.turns}}</span> turns)
                                </span>
                            </span>
                            <i ng-if="statusData.type == 0" class="fa fa-plus-circle" aria-hidden="true"><md-tooltip md-direction="left">Positive</md-tooltip></i>
                            <i ng-if="statusData.type == 1" class="fa fa-minus-circle" aria-hidden="true"><md-tooltip md-direction="left">Negative</md-tooltip></i>
                            <i ng-if="statusData.type == 2" class="fa fa-circle" aria-hidden="true"><md-tooltip md-direction="left">Neutral</md-tooltip></i>
                         </div>
                         <div ng-repeat="text in statusData.textFields" layout="row" ng-class="{'halfBottomMargin': !$last}">
                            {{text}}
                         </div>
                    </div>
                </div>
            </div>
            <md-divider></md-divider>
            <!-- Inventory -->
            <div class="rem1_2Text boldText" layout="row">
                <i class="fa fa-angle-down fa-fw clickable" ng-class="{'fa-rotate-270': !invExpanded}" ng-click="toggleInvExpanded()" aria-hidden="true"></i>
                Inventory
            </div>
            <md-card ng-repeat="item in selectedUnit.inventory track by $index" 
                     ng-click="item.expanded = !item.expanded" 
                     ng-if="invExpanded"
                     ng-init="itemData = data.system.items[item.name]"
                     class="md-card-hover clickable"
                     ng-style="{'pointer-events': item != null ? 'auto' : 'none'}">
                <div layout="row" layout-align="space-between center">
                    <span>
                        <img ng-if="itemData.spriteURL.length > 0" ng-src="{{itemData.spriteURL}}" style="margin-right: 8px; max-height: 24px; max-width: 24px;"/>
                        <span ng-class="{'droppableItemColor': item.isDroppable == true, 'opacity50': item == null || !item.canEquip}">
                            <span ng-if="item != null" style="font-style: bold;" >{{item.name}}</span>
                            <span ng-if="item == null" style="font-style: italic;">Empty</span>
                            <span ng-if="item.uses > 0">({{item.uses}})</span>
                        </span>
                    </span>
                    <span>
                        <i class="fa fa-gift" ng-if="item.isDroppable" aria-label="Droppable"><md-tooltip md-direction="top">Droppable</md-tooltip></i>
                        <i class="fa fa-star" ng-if="item.isEquipped" aria-label="Equipped"><md-tooltip md-direction="top">Equipped</md-tooltip></i>
                    </span>
                </div>
                <div layout="row" class="rem0_8Text leftPadding" ng-class="{'opacity50': !item.canEquip}">
                    <span ng-if="itemData.weaponRank.length > 0">{{itemData.weaponRank}}&nbsp;-&nbsp;</span>{{itemData.category}}<span ng-if="itemData.utilizedStat.length > 0">&nbsp;({{itemData.utilizedStat}})</span>
                </div>
                <div ng-if="item.expanded">
                    <div ng-if="itemData.range.minimum > 0 || itemData.uses > 0 || itemData.utilizedStat.length > 0" class="rem0_8Text">
                        <md-divider></md-divider>
                        <div layout="row" layout-wrap>
                            <div ng-if="itemData.utilizedStat.length > 0" ng-repeat="(stat, statVal) in itemData.stats" layout="row" layout-align="space-between" flex="33" class="horizontalPadding">
                                <span>{{stat}}</span>
                                <span>{{statVal}}</span>
                            </div>
                            <div ng-if="itemData.range.minimum > 0" layout="row" layout-align="space-between" flex="33" class="horizontalPadding">
                                <span>Rng</span>
                                <span>{{itemData.range.minimum}}<span ng-if="itemData.range.minimum != itemData.range.maximum">&nbsp;-&nbsp;{{itemData.range.maximum}}</span></span>
                            </div>
                            <div ng-if="itemData.maxUses > 0" layout="row" layout-align="space-between" flex="33" class="horizontalPadding">
                                <span>Uses</span>
                                <span>{{item.uses}}<span ng-if="itemData.maxUses > 0">&nbsp;/&nbsp;{{itemData.maxUses}}</span></span>
                            </div>
                        </div>
                    </div>
                    <div ng-if="itemData.textFields.length > 0">
                        <md-divider></md-divider>
                        <div ng-repeat="text in itemData.textFields" class="rem0_9Text" ng-class="{'bottomMargin': !$last}" layout="row">{{text}}</div>
                    </div>
                </div>
            </md-card>
            <md-divider></md-divider>
            <!--Skills-->
            <div ng-if="selectedUnit.skills.length > 0" class="rem1_2Text boldText" layout="row">
                <i class="fa fa-angle-down fa-fw clickable" ng-class="{'fa-rotate-270': !skillsExpanded}" ng-click="toggleSkillsExpanded()" aria-hidden="true"></i>
                Skills
            </div>
            <md-card ng-repeat="skill in selectedUnit.skills track by $index"
                        ng-if="skillsExpanded"
                        ng-init="skillData = data.system.skills[skill]"
                        class="md-card-hover">
                <div layout="row" layout-align="start center">
                    <img ng-if="skillData.spriteURL.length > 0" ng-src="{{skillData.spriteURL}}" style="margin-right: 8px; max-height: 24px; max-width: 24px;"/>
                    <span>{{skillData.name}}</span>
                </div>
                <md-divider></md-divider>
                <div ng-repeat="text in skillData.textFields" layout="row" class="rem0_9Text" ng-class="{'bottomMargin': !$last}">
                    {{text}}
                </div>
            </md-card>
        </md-content>
    </div>
    <!-- Tile display -->
    <div id="divTileDisplay" ng-show="displayTile" layout="column" class="verticalPadding horizontalPadding slide" style="width: 375px; height: 100%;">
        <md-content ng-if="selectedTile"class="horizontalPadding">
            <div layout="row" layout-align="left center" class="rem1_4Text boldText bottomMargin">
                <!--Tile preview-->
                <div ng-style="{'background-image': 'url({{data.map.mapImageURL}})', 'background-position': 'left -'+((data.map.constants.tileSize + data.map.constants.tileSpacing)*(selectedTile.coordinate.x-(data.map.constants.hasHeaderTopLeft ? 0 : 1)))+'px top -'+((data.map.constants.tileSize + data.map.constants.tileSpacing)*(selectedTile.coordinate.y-(data.map.constants.hasHeaderTopLeft ? 0 : 1)))+'px', 'width': (data.map.constants.tileSize + data.map.constants.tileSpacing)+'px', 'height': (data.map.constants.tileSize + data.map.constants.tileSpacing)+'px', 'overflow': hidden}"></div>
                <!--Coords-->
                <span class="leftPadding">Tile ({{selectedTile.coordinate.x}},{{selectedTile.coordinate.y}})</span>
            </div>
            <md-divider></md-divider>
            <div ng-if="selectedTile.occupyingUnitName.length > 0" layout="row" class="bottomMargin">
                <span class="boldText">Occupying Unit:</span>&nbsp;{{selectedTile.occupyingUnitName}}
            </div>
            <div layout="column" class="bottomMargin">
                <div layout="row">
                    <span class="boldText">Terrain Type:</span>&nbsp;{{selectedTile.terrainTypeName}}
                </div>
                <div layout="row" layout-wrap class="bottomMargin">
                    <div ng-repeat="(stat, val) in data.system.terrainTypes[selectedTile.terrainTypeName].statModifiers" layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                        <span>{{stat}}</span>
                        <span>
                            <span ng-if="val >= 0">+</span>{{val}}
                        </span>
                    </div>
                </div>
                <div layout="row" ng-repeat="text in data.system.terrainTypes[selectedTile.terrainTypeName].textFields" class="rem0_9Text leftPadding" ng-class="{'bottomMargin': !$last}">
                    {{text}}
                </div>
            </div>
        </md-content>
    </div>

    <!-- Map -->
    <md-content id="mapScollBox" class="backgroundTexture" layout-padding flex>
        <div class="mapBackground"
             ng-style="{'background-image': 'url({{data.map.mapImageURL}})', 'width': data.map.mapImageWidth + 'px', 'height': data.map.mapImageHeight + 'px', 'padding-top': data.map.constants.hasHeaderTopLeft ? (data.map.constants.tileSize)+'px' : '0px', 'padding-left': data.map.constants.hasHeaderTopLeft ? (data.map.constants.tileSize)+'px' : '0px'}">
             <!--Draw tiles-->
             <div ng-repeat="row in data.map.tiles"
                 class="mapRow"
                 ng-style="{'height': data.map.constants.tileSize+'px', 'margin-bottom': data.map.constants.tileSpacing+'px'}">
                <div ng-repeat="tile in row" 
                     class="mapTile"
                     ng-style="{'width': (data.map.constants.tileSize+1)+'px', 'height': (data.map.constants.tileSize+1)+'px', 'margin-right': data.map.constants.tileSpacing+'px'}"
                     ng-attr-title="({{tile.coordinate.x}},{{tile.coordinate.y}}) {{tile.terrainTypeName}}"
                     ng-mouseover="mapTile_OnMouseover(tile)"
                     ng-mouseout="mapTile_OnMouseout(tile)"
                     ng-click="mapTile_OnClick(tile)"
                     ng-class="{'clickable': tile.occupyingUnitName.length > 0, 'inRangeMovColor': tile.movCount > 0, 'inRangeAtkColor': tile.atkCount > 0 && tile.movCount == 0, 'inRangeStaffColor': tile.utilCount > 0 && tile.atkCount == 0 && tile.movCount == 0}"
                >
                    <!--Draw unit-->
                    <div ng-if="tile.isUnitAnchor"
                         ng-init="unit = getUnitByName(tile.occupyingUnitName)"
                         class="unitSpriteContainer"
                         ng-style="{'width': ((data.map.constants.tileSize + data.map.constants.tileSpacing) * unit.unitSize)+'px', 'height': ((data.map.constants.tileSize + data.map.constants.tileSpacing) * unit.unitSize)+'px'}"
                         layout="row"
                         layout-align="center end"
                    >
                        <img id="{{unit.name}}_sprite" ng-src="{{unit.spriteURL}}" class="unitSpriteImage" ng-class="{'grayscale': unit.hasMoved}" />
                        <div id="unitNumber" class="unitNumber">
                            <img ng-repeat="digit in unit.unitNumber.split('') track by $index"
                                 ng-src="IMG/num_{{digit}}.png"
                                 style="width: 5px; height: 7px;" />
                        </div>
                        <div id="healthBarBorder" class="healthBarBorder">
                            <div id="healthBarFillBackground" class="healthBarFill" style="background-color: gray;"></div>
                            <div id="healthBarFillColor"
                                 class="healthBarFill"
                                 ng-style="{'width': unit.hp.percentage + '%'}"
                                 ng-class="{'hpOverfillColor': unit.hp.percentage > 100, 'hp100PercentColor': unit.hp.percentage <= 100 && unit.hp.percentage > 50, 'hp50PercentColor': unit.hp.percentage <= 50 && unit.hp.percentage > 25, 'hp25PercentColor': unit.hp.percentage <= 25}"
                            ></div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </md-content>
</div>
