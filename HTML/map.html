<div  ng-if="!loadComplete" layout="column" layout-align="center center" layout-fill>
    <div ng-if="!errorContext" layout="column" layout-align="center center">
        <md-progress-circular md-mode="indeterminate"></md-progress-circular>
        <span style="margin-top: 15px;">Fetching map data</span>
    </div>
    <div ng-if="errorContext" layout="row" layout-align="center" style="width: 75%;">
        <div layout="column">
            <div layout="row" class="rem2_25Text">
                <i ng-if="errorContext.status != 403" class="fa fa-exclamation-circle fa-fw errorMessageColor" aria-hidden="true"></i>
                <i ng-if="errorContext.status == 403" class="fa fa-exclamation-triangle fa-fw warningMessageColor" aria-hidden="true"></i>
            </div>
        </div>
        <div layout="column">
            <div layout="row" class="rem2_25Text">
                <span ng-if="errorContext.status != 403" class="errorMessageColor">A fatal error has occurred.</span>
                <span ng-if="errorContext.status == 403" class="warningMessageColor">Access is blocked.</span>
            </div>
            <div layout="column">
                <div layout="row" layout-align="left center">
                    <span>{{errorContext.message}}</span>
                </div>
                <div ng-if="errorContext.innerException != null" layout="row" layout-align="left center">
                    <span>{{errorContext.innerException.message}}</span>
                </div>
                <div layout="row" layout-align="left center" style="white-space: pre-wrap; color: gray;">
                    <span ng-if="errorContext.innerException == null && errorContext.status != 403">{{formatStackTrace(errorContext.stackTrace)}}</span>
                    <span ng-if="errorContext.innerException != null">{{formatStackTrace(errorContext.innerException.stackTrace)}}</span>
                </div>
            </div>
        </div>
    </div>
</div>
<div ng-if="loadComplete" layout="row" layout-fill>
    <!--Button toolbar-->
    <div id="divToolbar" layout="column" layout-align="space-between center" class="verticalPadding toolbarColor" style="width: 55px; height: 100%;">
        <div>
            <md-button id="btnShowSideNav" class="md-icon-button" ng-class="{'toolbarButtonColor': displayUnits}" ng-click="displayUnits = !displayUnits; displayTile = false;">
                <i class="fa fa-bars fa-lg" aria-hidden="true"></i>
            </md-button>
            <md-button id="btnShowTileInfo" class="md-icon-button" ng-class="{'toolbarButtonColor': displayTile}" ng-click="displayTile = !displayTile; displayUnits = false;">
                <i class="fa fa-square-o fa-lg" aria-hidden="true"></i>
            </md-button>
        </div>
        <div>
            <md-button id="btnLaunchConvoy" class="md-icon-button" ng-if="data.showConvoyLink" ng-click="navigateConvoy()">
                <i class="fa fa-archive fa-lg" aria-hidden="true"></i>
            </md-button>
            <md-button id="btnLaunchShop" class="md-icon-button" ng-if="data.showShopLink" ng-click="navigateShop()">
                <i class="fa fa-shopping-basket fa-lg" aria-hidden="true"></i>
            </md-button>
            <md-button id="btnLaunchChapterPost" class="md-icon-button" ng-if="data.map.chapterPostURL.length > 0" ng-click="launchChapterPostTab()">
                <i class="fa fa-reddit fa-lg" aria-hidden="true"></i>
            </md-button>
            <md-button id="btnBack" class="md-icon-button" ng-click="navigateHome()">
                <i class="fa fa-arrow-left fa-lg" aria-hidden="true"></i>
            </md-button>
        </div>
    </div>
    <!-- Search and unit display -->
    <div id="divUnitDisplay" ng-show="displayUnits" layout="column" class="verticalPadding horizontalPadding slide" style="width: 375px; height: 100%;">
        <!-- Search field -->
        <md-autocomplete
                id="mdAutoComplete"
                md-selected-item="search.selected"
                md-search-text="search.query"
                md-items="unit in data.units | orderBy: [unitSort, 'name'] | filter: search.query"
                md-item-text="unit.name"
                md-dropdown-items="5"
                md-min-length="0"
                md-escape-options="clear"
                md-no-cache="true"
                placeholder="Unit Name">
            <md-item-template>
                <div layout="row" layout-align="space-between center">
                    <span md-highlight-text="search.query" md-highlight-flags="^i">{{unit.name}}</span>
                    <div layout="row">
                        <i ng-if="unit.coordinate.x < 1 || unit.coordinate.y < 1" class="fa fa-eye-slash fa-lg fa-fw" aria-hidden="true"><md-tooltip md-direction="top">Hidden</md-tooltip></i>
                        <i ng-if="unit.pinned" class="fa fa-thumb-tack fa-lg fa-fw fa-rotate-45" aria-hidden="true"><md-tooltip md-direction="top">Pinned</md-tooltip></i>
                    </div>
                </div>
            </md-item-template>
        </md-autocomplete>
        <!--Unit display-->
        <md-content ng-if="search.selected" layout-padding>
            <!-- Sprite, name, & pin icon -->
            <div layout="row" layout-align="space-between">
                <div layout="column">
                    <div layout="row">
                        <img ng-src="{{search.selected.spriteURL}}" style="max-width: 100px; max-height: 100px;"/>
                    </div>
                    <div layout="row">
                        <div layout="column" class="rem1_4Text boldText">
                            <i class="fa fa-angle-down fa-fw clickable" ng-class="{'fa-rotate-270': !unitInfoExpanded}" ng-click="unitInfoExpanded = !unitInfoExpanded" aria-hidden="true"></i>
                        </div>
                        <div layout="column">
                            <span class="rem1_4Text boldText">{{search.selected.name}}</span>
                            <span class="rem0_9Text leftPadding">Lvl. {{search.selected.level}} {{search.selected.classes[0]}}</span>
                        </div>
                    </div>
                </div>
                <div layout="column">
                    <i ng-click="toggleUnitPinnedStatus(search.selected)" ng-class="{'opacity50': !search.selected.pinned}" class="fa fa-thumb-tack fa-lg fa-rotate-45 clickable" aria-hidden="true">
                        <md-tooltip md-direction="left">{{search.selected.pinned ? 'Unpin' : 'Pin'}} unit</md-tooltip>
                    </i>
                </div>
            </div>
            <!--Expanded unit info-->
            <div layout="column" ng-if="unitInfoExpanded">
                <div layout="row" ng-repeat="text in search.selected.textFields track by $index" class="rem0_9Text bottomMargin">
                    {{text}}
                </div>
                <div ng-if="search.selected.player.length > 0" layout="row" class="rem0_9Text bottomMargin">
                    <b>Player</b>: {{search.selected.player}}
                </div>
                <div ng-repeat="class in search.selected.classes track by class" layout="column" class="bottomMargin">
                    <div layout="row" class="rem0_9Text">
                        <b>Class</b>: {{class}}
                    </div>
                    <div layout="row" ng-repeat="text in data.system.classes[class].textFields track by $index" class="rem0_8Text leftPadding" ng-class="{'bottomMargin': !$last}">
                        {{text}}
                    </div>
                </div>
                <div layout="column">
                    <div layout="row" class="rem0_9Text">
                        <b>Affiliation</b>: {{search.selected.affiliation}}
                    </div>
                    <div layout="row" ng-repeat="text in data.system.affiliations[search.selected.affiliation].textFields track by $index" class="rem0_8Text leftPadding">
                        {{text}}
                    </div>
                </div>      
            </div>
            <md-divider ng-if="unitInfoExpanded"></md-divider>
            <div layout="row" layout-wrap>
                <!--HP-->
                <div layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                    <span>HP</span>
                    <span>{{search.selected.hp.current}} / {{search.selected.hp.maximum}}</span>
                </div>
                <!--Exp-->
                <div layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                    <span>Exp</span>
                    <span>{{search.selected.experience}}</span>
                </div>
                <!--Currency-->
                <div ng-if="search.selected.heldCurrency > 0" layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                    <span>Money</span>
                    <span>
                        <span ng-if="data.system.currency.isSymbolLeftAligned"><span ng-if="data.system.currency.includeSpace">&nbsp;</span>{{data.system.currency.currencySymbol}}</span>{{search.selected.heldCurrency}}<span ng-if="!data.system.currency.isSymbolLeftAligned"><span ng-if="data.system.currency.includeSpace">&nbsp;</span>{{data.system.currency.currencySymbol}}</span>
                    </span>
                </div>
            </div>
            <!--Tags-->
            <div layout="row" ng-if="search.selected.tags.length > 0">
                <div layout="column" style="margin-right: 8px; padding-top: 5px;">
                    <i class="fa fa-tags" aria-hidden="true">
                        <md-tooltip md-direction="top">Tags</md-tooltip>
                    </i>
                </div>
                <div layout="row" layout-wrap>
                    <div ng-repeat="tag in search.selected.tags track by tag" class="md-chip-custom">{{tag}}</div>
                </div>
            </div>
            <!-- Stats -->
            <div class="rem1_2Text boldText" layout="row">
                <i class="fa fa-angle-down fa-fw clickable" ng-class="{'fa-rotate-270': !statsExpanded}" ng-click="toggleStatsExpanded()" aria-hidden="true"></i>
                Stats
            </div>
            <!-- Combat stats -->
            <modifiedstatlist data="search.selected.combatStats" expanded="statsExpanded" layout="row" layout-wrap></modifiedstatlist>
            <!-- System stats -->
            <modifiedstatlist ng-if="Object.keys(search.selected.systemStats).length > 0" data="search.selected.systemStats" expanded="statsExpanded" layout="row" layout-wrap></modifiedstatlist>
            <!-- Regular stats -->
            <modifiedstatlist data="search.selected.stats" expanded="statsExpanded" layout="row" layout-wrap></modifiedstatlist>
            <!--Weapon ranks-->
            <div layout="row">
                <div layout="row" style="margin-right: 8px; padding-top: 5px;">
                    <i class="fa fa-tasks" aria-hidden="true">
                        <md-tooltip md-direction="top">Weapon Ranks</md-tooltip>
                    </i>
                </div>
                <div layout="row" layout-wrap>
                    <div ng-repeat="(tag, rank) in search.selected.weaponRanks track by tag" class="md-chip-custom">{{tag}}<span ng-if="rank.length > 0"> - {{rank}}</span></div>
                </div>
            </div>
            <!-- Statuses -->
            <div ng-if="search.selected.statusConditions.length > 0" layout="row">
                <div layout="row" style="margin-right: 8px; padding-top: 5px;">
                    <i class="fa fa-medkit" aria-hidden="true">
                        <md-tooltip md-direction="top">Status Conditions</md-tooltip>
                    </i>
                </div>
                <div layout="column" flex="100" style="padding-right: 8px;">
                   <statuscondition ng-repeat="status in search.selected.statusConditions track by $index"
                                    status="status"
                                    sysdata="data.system.statusConditions[status.name]"></statuscondition>
                </div>
            </div>
            <md-divider></md-divider>
            <!-- Inventory -->
            <div class="rem1_2Text boldText" layout="row">
                <i class="fa fa-angle-down fa-fw clickable" ng-class="{'fa-rotate-270': !invExpanded}" ng-click="toggleInvExpanded()" aria-hidden="true"></i>
                Inventory
            </div>
            <div layout="column" ng-if="invExpanded">
                <inventoryitem ng-repeat="item in search.selected.inventory track by $index"  
                               item="item"
                               sysdata="data.system.items[item.name]">
                </inventoryitem>
            </div>
            <md-divider></md-divider>
            <!--Skills-->
            <div ng-if="search.selected.skills.length > 0" class="rem1_2Text boldText" layout="row">
                <i class="fa fa-angle-down fa-fw clickable" ng-class="{'fa-rotate-270': !skillsExpanded}" ng-click="toggleSkillsExpanded()" aria-hidden="true"></i>
                Skills
            </div>
            <div layout="column" ng-if="skillsExpanded">
                <skill ng-repeat="skill in search.selected.skills track by $index"
                       skill="skill"
                       sysdata="data.system.skills[skill]">
                </skill>
            </div>
        </md-content>
    </div>
    <!-- Tile display -->
    <div id="divTileDisplay" ng-show="displayTile" layout="column" class="verticalPadding horizontalPadding slide" style="width: 375px; height: 100%;">
        <md-content ng-if="selectedTile"class="horizontalPadding">
            <div layout="row" layout-align="left center" class="rem1_4Text boldText bottomMargin">
                <!--Tile preview-->
                <div ng-style="{'background-image': 'url({{data.map.mapImageURL}})', 'background-position': 'left -'+((data.map.constants.tileSize + data.map.constants.tileSpacing)*(selectedTile.coordinate.x-(data.map.constants.hasHeaderTopLeft ? 0 : 1)))+'px top -'+((data.map.constants.tileSize + data.map.constants.tileSpacing)*(selectedTile.coordinate.y-(data.map.constants.hasHeaderTopLeft ? 0 : 1)))+'px', 'width': (data.map.constants.tileSize + data.map.constants.tileSpacing)+'px', 'height': (data.map.constants.tileSize + data.map.constants.tileSpacing)+'px', 'overflow': hidden}"></div>
                <!--Coords-->
                <span class="leftPadding">Tile ({{selectedTile.coordinate.x}},{{selectedTile.coordinate.y}})</span>
            </div>
            <md-divider></md-divider>
            <!-- Occupying Unit -->
            <div ng-if="selectedTile.occupyingUnitName.length > 0" layout="row" class="bottomMargin">
                <span class="boldText">Occupying Unit:</span>&nbsp;{{selectedTile.occupyingUnitName}}
            </div>
            <!-- Terrain Type -->
            <div layout="column" class="bottomMargin">
                <div layout="row">
                    <span class="boldText">Terrain Type:</span>&nbsp;{{selectedTile.terrainType}}
                </div>
                <div layout="row" layout-wrap class="rem0_9Text bottomMargin">
                    <div ng-if="data.system.terrainTypes[selectedTile.terrainType].hpModifier != 0" layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                        <span>HP</span>
                        <span>
                            <span ng-if="data.system.terrainTypes[selectedTile.terrainType].hpModifier >= 0">+</span>{{effectData.hpModifier}}%
                        </span>
                    </div>
                    <!-- Combat Stat Modifiers -->
                    <div ng-repeat="(stat, val) in data.system.terrainTypes[selectedTile.terrainType].combatStatModifiers" layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                        <span>{{stat}}</span>
                        <span>
                            <span ng-if="val >= 0">+</span>{{val}}
                        </span>
                    </div>
                    <!-- Stat Modifiers -->
                    <div ng-repeat="(stat, val) in data.system.terrainTypes[selectedTile.terrainType].statModifiers" layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                        <span>{{stat}}</span>
                        <span>
                            <span ng-if="val >= 0">+</span>{{val}}
                        </span>
                    </div>
                </div>
                <div layout="row" ng-repeat="text in data.system.terrainTypes[selectedTile.terrainType].textFields" class="rem0_9Text leftPadding" ng-class="{'bottomMargin': !$last}">
                    {{text}}
                </div>
            </div>
            <!-- Terrain Effects -->
            <div ng-repeat="effect in selectedTile.terrainEffects"
                 ng-init="effectData = data.system.terrainEffects[effect.name]"
                 layout="column"
                 class="bottomMargin">
                <div layout="row">
                    <span class="boldText">Terrain Effect:</span>&nbsp;{{effectData.name}}
                </div>
                <div layout="row" layout-wrap class="rem0_9Text bottomMargin">
                    <div ng-if="effectData.hpModifier != 0" layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                        <span>HP</span>
                        <span>
                            <span ng-if="effectData.hpModifier >= 0">+</span>{{effectData.hpModifier}}%
                        </span>
                    </div>
                    <!-- Combat Stat Modifiers -->
                    <div ng-repeat="(stat, val) in effectData.combatStatModifiers" layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                        <span>{{stat}}</span>
                        <span>
                            <span ng-if="val >= 0">+</span>{{val}}
                        </span>
                    </div>
                    <!-- Stat Modifiers -->
                    <div ng-repeat="(stat, val) in effectData.statModifiers" layout="row" layout-align="space-between" flex="50" class="horizontalPadding">
                        <span>{{stat}}</span>
                        <span>
                            <span ng-if="val >= 0">+</span>{{val}}
                        </span>
                    </div>
                </div>
                <div layout="row" ng-repeat="text in effectData.textFields" class="rem0_9Text leftPadding" ng-class="{'bottomMargin': !$last}">
                    {{text}}
                </div>
            </div>
        </md-content>
    </div>

    <!-- Map -->
    <md-content id="mapScollBox" class="backgroundTexture" layout-padding flex
                ng-style="{'min-width': data.map.mapImageWidth + 'px', 'min-height': data.map.mapImageHeight + 'px'}">
        <div class="mapBackground"
             ng-style="{'background-image': 'url({{data.map.mapImageURL}})', 'width': data.map.mapImageWidth + 'px', 'height': data.map.mapImageHeight + 'px', 'padding-top': data.map.constants.hasHeaderTopLeft ? (data.map.constants.tileSize)+'px' : '0px', 'padding-left': data.map.constants.hasHeaderTopLeft ? (data.map.constants.tileSize)+'px' : '0px'}">
             <!--Draw tiles-->
             <div ng-repeat="row in data.map.tiles track by $index"
                 class="mapRow"
                 ng-style="{'height': data.map.constants.tileSize+'px', 'margin-bottom': data.map.constants.tileSpacing+'px'}">
                <div ng-repeat="tile in row track by $index" 
                     class="mapTile"
                     ng-style="{'width': (data.map.constants.tileSize+1)+'px', 'height': (data.map.constants.tileSize+1)+'px', 'margin-right': data.map.constants.tileSpacing+'px'}"
                     title="({{tile.coordinate.x}},{{tile.coordinate.y}}) {{tile.terrainType}}"
                     ng-mouseover="mapTile_OnMouseover(tile)"
                     ng-mouseout="mapTile_OnMouseout(tile)"
                     ng-click="mapTile_OnClick(tile)"
                     ng-class="{'clickable': tile.occupyingUnitName.length > 0, 'inRangeMovColor': tile.movCount > 0, 'inRangeAtkColor': tile.atkCount > 0 && tile.movCount == 0, 'inRangeStaffColor': tile.utilCount > 0 && tile.atkCount == 0 && tile.movCount == 0}"
                >
                    <!-- Draw terrain effect -->
                    <div ng-repeat="effect in tile.terrainEffects track by effect.name"
                         ng-if="effect.isAnchor"
                         ng-init="effectData = data.system.terrainEffects[effect.name]"
                         class="spriteContainer"
                         ng-style="{'width': ((data.map.constants.tileSize + data.map.constants.tileSpacing) * effectData.size)+'px', 'height': ((data.map.constants.tileSize + data.map.constants.tileSpacing) * effectData.size)+'px'}"
                         layout="row"
                         layout-align="center end">
                         <img ng-src="{{effectData.spriteURL}}" />
                    </div>

                    <!--Draw unit-->
                    <div ng-if="tile.isUnitAnchor"
                         ng-init="unit = getUnitByName(tile.occupyingUnitName)"
                         class="spriteContainer"
                         ng-style="{'width': ((data.map.constants.tileSize + data.map.constants.tileSpacing) * unit.unitSize)+'px', 'height': ((data.map.constants.tileSize + data.map.constants.tileSpacing) * unit.unitSize)+'px', 'z-index': tile.coordinate.y + unit.unitSize}"
                         layout="row"
                         layout-align="center end"
                    >
                        <img id="{{unit.name}}_sprite" ng-src="{{unit.spriteURL}}" class="unitSpriteImage" ng-class="{'grayscale': unit.hasMoved}" />
                        <div ng-if="unit.statusConditions.length > 0" id="statusConditionIcon" class="unitStatusCondition">
                            <img ng-src="IMG/status_heart.png" />
                        </div>
                        <div id="unitNumber" class="unitNumber">
                            <img ng-repeat="digit in unit.unitNumber.split('') track by $index"
                                 ng-src="IMG/num_{{digit}}.png"
                                 style="width: 5px; height: 7px;" />
                        </div>
                        <div id="healthBarBorder" class="healthBarBorder">
                            <div id="healthBarFillBackground" class="healthBarFill" style="background-color: gray;"></div>
                            <div id="healthBarFillColor"
                                 class="healthBarFill"
                                 ng-style="{'width': unit.hp.percentage + '%'}"
                                 ng-class="{'hpOverfillColor': unit.hp.percentage > 100, 'hp100PercentColor': unit.hp.percentage <= 100 && unit.hp.percentage > 50, 'hp50PercentColor': unit.hp.percentage <= 50 && unit.hp.percentage > 25, 'hp25PercentColor': unit.hp.percentage <= 25}"
                            ></div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </md-content>
</div>
